<!--views/client/special-order-view.ejs-->
<% /* Client weekly plan view (no inline script) */ %>
<div class="weekly-plan container">
  <h2>Weekly Plan — <%= plan.id %></h2>

  <input type="hidden" id="currentWeeklyPlanId" value="<%= plan.id %>" />

  <!-- Arrange items into days (server-side ordering Mon→Fri) -->
  <% 
    const weekdayOrder = { monday: 1, tuesday: 2, wednesday: 3, thursday: 4, friday: 5 };
    const orderedDays = ['monday','tuesday','wednesday','thursday','friday'];
    // Group items by day and sort slots ascending
    const itemsByDay = {};
    (plan.items || []).forEach(it => {
      const day = (it.day_of_week || '').toLowerCase();
      if (!itemsByDay[day]) itemsByDay[day] = [];
      itemsByDay[day].push(it);
    });
    orderedDays.forEach(d => {
      if (itemsByDay[d]) itemsByDay[d].sort((a,b)=> (Number(a.slot)||0) - (Number(b.slot)||0));
    });
  %>

  <section class="weekly-summary">
    <h3>Summary</h3>

    <p><strong>Customer:</strong><br />
      <span><strong>Name:</strong> <%= plan.client_name || 'Unknown' %></span><br />
      <span><strong>Phone:</strong>
        <% if (plan.client_phone) { %>
          <a href="tel:<%= plan.client_phone %>"><%= plan.client_phone %></a>
        <% } else { %> — <% } %>
      </span><br />
      <span><strong>Address:</strong> <%= plan.client_address || plan.address || '—' %></span>
      <% if (plan.client_lat && plan.client_lng) { %>
        <br />
        <a href="https://www.google.com/maps/search/?api=1&query=<%= plan.client_lat %>,<%= plan.client_lng %>" target="_blank" rel="noopener noreferrer">View on map</a>
      <% } %>
    </p>

    <p><strong>Week (Monday):</strong> <%= plan.week_of ? (plan.week_of.toISOString ? plan.week_of.toISOString().slice(0,10) : plan.week_of) : '—' %></p>
    <p><strong>Plan type:</strong> <%= plan.plan_type %></p>
    <p><strong>Total price:</strong> ₦<%= plan.total_price %></p>
    <p><strong>Status:</strong> <%= plan.status %></p>
    <p><strong>Food Specialist:</strong> <%= plan.assigned_admin_name || 'Unassigned' %></p>
    <p><strong>Modifiable window:</strong>
      <% if (plan.modifiable_from && plan.modifiable_until) { %>
        <%= new Date(plan.modifiable_from).toLocaleString() %> — <%= new Date(plan.modifiable_until).toLocaleString() %>
      <% } else { %> — <% } %>
    </p>
  </section>

  <section class="meals-snapshot">
    <h3>Meals (Snapshot)</h3>

    <% if (!plan.items || !plan.items.length) { %>
      <p>No meals recorded for this plan.</p>
    <% } else { %>
      <div class="table-wrap">
        <table class="table-weekly-snapshot">
          <thead>
            <tr>
              <th>Day</th>
              <th>Slot</th>
              <th>Food</th>
            </tr>
          </thead>
          <tbody>
            <% orderedDays.forEach(function(day) { 
                 const items = itemsByDay[day] || [];
                 if (items.length === 0) { %>
                   <tr>
                     <td data-label="Day"><%= day.charAt(0).toUpperCase() + day.slice(1) %></td>
                     <td data-label="Slot">—</td>
                     <td data-label="Food">—</td>
                   </tr>
            <%   } else {
                   items.forEach(function(it) { %>
                     <tr>
                       <td data-label="Day"><%= day.charAt(0).toUpperCase() + day.slice(1) %></td>
                       <td data-label="Slot"><%= it.slot %></td>
                       <td data-label="Food"><%= it.food_label || it.food_key || '—' %></td>
                     </tr>
            <%       });
                 }
               }); %>
          </tbody>
        </table>
      </div>
    <% } %>
  </section>

  <section>
    <h3>Messages</h3>
    <div id="weeklyPlanMessages" class="weekly-messages" aria-live="polite">
      <% if (messages && messages.length) { %>
        <% messages.forEach(function(m) {
            var senderName = m.display_name;
            if (!senderName) {
              if (m.sender_type === 'client') senderName = plan.client_name || 'Customer';
              else if (m.sender_type === 'admin') senderName = plan.assigned_admin_name || 'Food Specialist';
              else senderName = m.sender_type || 'Support';
            }
        %>
          <div class="weekly-plan-msg">
            <strong><%= senderName %></strong>
            <div><%= m.message %></div>
            <div style="font-size:0.8em;color:var(--muted)"><%= new Date(m.created_at).toLocaleString() %></div>
          </div>
        <% }); %>
      <% } else { %>
        <p>No messages yet.</p>
      <% } %>
    </div>
  </section>

  <section style="margin-top:1rem" class="weekly-actions">
    <% if (plan.status !== 'completed') { %>
      <form method="post" action="/client/special-order/<%= plan.id %>/update" style="display:inline">
        <button type="submit" class="btn btn-primary">Modify (if allowed)</button>
      </form>
    <% } %>
    <a href="/client/dashboard" style="margin-left:12px">Back to dashboard</a>
  </section>

  <section style="margin-top:1rem">
    <div class="weekly-chat">
      <input id="weeklyPlanChatInput" placeholder="Write a message to team..." />
      <button id="weeklyPlanSendBtn" class="btn btn-primary">Send</button>
    </div>
  </section>

  <%- include('../partials/chat-modal') %>
</div>
