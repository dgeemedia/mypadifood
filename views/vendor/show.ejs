<!-- views/vendor/show.ejs -->
<% 
/* helpers (safe, local assets only)
   - FOOD_IMAGES map maps normalized food keys to /public/images/food/*.jpg
   - vendorImageFor(v): prefer vendor.photo_url (absolute or site path), else map by food_item/name, else placeholder
   - fallbackHero: small inline SVG used as data URI fallback
*/
const FOOD_IMAGES = {
  jollof: '/images/food/jollof.jpg',
  white_rice_stew: '/images/food/white_rice_stew.jpg',
  fried_rice: '/images/food/fried_rice.jpg',
  eba_egusi: '/images/food/eba_egusi.jpg',
  amala_ewedu: '/images/food/amala_ewedu.jpg',
  beans_ewa_riro: '/images/food/beans_ewa_riro.jpg',
  akara: '/images/food/akara.jpg',
  moi_moi: '/images/food/moi_moi.jpg',
  pounded_yam_egusi: '/images/food/pounded_yam_egusi.jpg',
  ofada_ayamase: '/images/food/ofada_ayamase.jpg',
  suya: '/images/food/suya.jpg',
  fish_pepper_soup: '/images/food/fish_pepper_soup.jpg',
  plantain_stew: '/images/food/plantain_stew.jpg',
  spaghetti_meat: '/images/food/spaghetti_meat.jpg',
  okro_fufu: '/images/food/okro_fufu.jpg',
  salad: '/images/food/salad.jpg',
  grilled_chicken: '/images/food/grilled_chicken.jpg',
  placeholder: '/images/food/placeholder.jpg'
};

function normalizeKey(s) {
  if (!s) return '';
  return String(s).toLowerCase()
    .replace(/&/g, 'and')
    .replace(/\s+/g, '_')
    .replace(/[^\w_]/g, '');
}

function vendorImageFor(v) {
  if (!v) return FOOD_IMAGES.placeholder;
  const p = v.photo_url ? String(v.photo_url).trim() : '';
  // allow absolute URLs or site-rooted paths
  if (p && (/^https?:\/\//i.test(p) || p.startsWith('/'))) return p;
  const key = normalizeKey(v.food_item || v.food || v.name || '');
  if (key && FOOD_IMAGES[key]) return FOOD_IMAGES[key];
  return FOOD_IMAGES.placeholder;
}

/* small inline SVG fallback for hero */
const fallbackHero = encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="400" viewBox="0 0 1200 400" preserveAspectRatio="xMidYMid slice">
    <rect width="100%" height="100%" fill="#f6f7fb"/>
    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="28" fill="#888">Image unavailable</text>
  </svg>
`);

/* vendorHero: prefer vendor.photo_url, else pick a food-mapped image */
const vendorHero = (typeof vendor !== 'undefined' && vendor && vendor.photo_url && vendor.photo_url.trim())
  ? vendor.photo_url.trim()
  : vendorImageFor(typeof vendor !== 'undefined' ? vendor : null);
%>

<section class="vendor-profile container">
  <div class="vendor-hero" style="position: relative; margin-bottom: 20px;">
    <img
      class="vendor-hero-img"
      alt="Food by <%= vendor && vendor.name ? vendor.name : 'Vendor' %>"
      src="<%= vendorHero %>"
      onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<%= fallbackHero %>'"
      loading="lazy"
      style="width:100%; display:block; height:auto; border-radius:12px; object-fit:cover;"
    />
  </div>

  <header class="vendor-header" style="display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 18px;">
    <div class="vendor-info" style="flex:1; min-width:0;">
      <h2 style="margin:0 0 6px 0;"><%= vendor && vendor.name ? vendor.name : 'Vendor' %></h2>
      <p class="vendor-location" style="margin:0; color: #6b7280;">
        <i class="fa fa-map-marker-alt" aria-hidden="true"></i>
        <span style="margin-left:8px;"><%= vendor && (vendor.lga || vendor.state) ? [vendor.lga, vendor.state].filter(Boolean).join(', ') : (vendor && vendor.state ? vendor.state : 'Unknown location') %></span>
      </p>
    </div>

    <div class="vendor-actions" style="display:flex; gap:8px; align-items:center;">
      <button
        class="btn btn-small btn-leave-review"
        data-vendor-id="<%= vendor && vendor.id ? vendor.id : '' %>"
        data-vendor-name="<%= vendor && vendor.name ? vendor.name : '' %>"
        type="button"
      >
        <i class="fa fa-star" aria-hidden="true"></i> Review
      </button>

      <%
  // determine logged-in user object (adapt to your variable names)
  const viewer = (typeof currentUser !== 'undefined' && currentUser) ? currentUser : (typeof user !== 'undefined' && user) ? user : null;
  const vendorIdSafe = vendor && vendor.id ? vendor.id : '';
%>

<% if (viewer) { %>
  <!-- signed-in users -> client dashboard, anchor to vendors section so vendor card is visible -->
  <a class="btn btn-primary" href="/client/dashboard?vendorId=<%= vendorIdSafe %>#section-vendors">Order now</a>
<% } else { %>
  <a class="btn btn-primary" href="/login?next=/vendor/<%= vendorIdSafe %>/order">Order now</a>
<% } %>

    </div>
  </header>

  <section class="vendor-about card" style="margin-bottom:16px;">
    <h3 style="margin-top:0;">About <%= vendor && vendor.name ? vendor.name : 'this vendor' %></h3>

    <% if (vendor && vendor.description && vendor.description.length > 25) { %>
      <p><%= vendor.description %></p>
    <% } else { %>
      <p>
        <%= vendor && vendor.name ? vendor.name : 'This vendor' %> is a trusted local food vendor,
        serving freshly prepared meals in <%= vendor && vendor.state ? vendor.state : 'the area' %>. We focus on tasty,
        reliable service.
      </p>
    <% } %>
  </section>

  <section class="vendor-menu card" style="margin-bottom:16px;">
    <h3 style="margin-top:0;">Menu</h3>

    <% if (typeof menuItems !== 'undefined' && Array.isArray(menuItems) && menuItems.length) { %>
      <ul class="menu-list" style="list-style:none; padding:0; margin:0; display:block;">
        <% menuItems.forEach(function(item) { %>
          <li class="menu-item" style="display:flex; justify-content:space-between; align-items:flex-start; padding:12px 0; border-bottom:1px solid rgba(15,23,42,0.03);">
            <div class="item-info" style="flex:1; min-width:0;">
              <strong style="display:block;"><%= item.name %></strong>
              <% if (item.description) { %>
                <p style="margin:6px 0 0 0; color: #6b7280;"><%= item.description %></p>
              <% } %>
            </div>
            <div class="item-price" style="margin-left:12px; white-space:nowrap; color:var(--brand-2); font-weight:700;">
              â‚¦<%= item.price %>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p>No menu items found for this vendor.</p>
    <% } %>
  </section>

  <section class="vendor-reviews card" style="margin-bottom:16px;">
    <h3 style="margin-top:0;">Reviews</h3>
    <%- include('../partials/reviews', { reviews: (typeof reviews !== 'undefined' ? reviews : []) }) %>
  </section>
</section>

<script src="/js/review.js" defer></script>
