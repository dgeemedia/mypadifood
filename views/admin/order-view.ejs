<!--views/admin/order-view.ejs-->
<h2>
  Order:
  <%= order.id %>
</h2>
<p>
  Customer: <%= order.client_name %> | Phone: <%= order.client_phone %> | Address:
  <%= order.client_address %>
</p>
<p>
  Vendor: <%= order.vendor_name %> | Vendor address: <%= order.vendor_address %>
</p>

<p>
  Status: <strong><%= order.status %></strong>
  <% if (order.assigned_admin) { %>
  &nbsp;| Assigned to:
  <%= order.assigned_admin %>
  <% } %>
</p>

<!-- Messages styled with chat UI -->
<div class="messages">
  <% messages.forEach(m => { %>
  <div class="msg <%= m.sender_type %>">
    <div class="msg-header">
      <span class="msg-sender"><%= m.display_name %></span>
      <span class="msg-time"
        ><%= new Date(m.created_at).toLocaleString() %></span
      >
    </div>
    <div class="msg-body"><%= m.message %></div>
  </div>
  <% }) %>
</div>

<form id="adminSend" style="margin-top: 12px">
  <textarea
    name="message"
    id="adminMessage"
    placeholder="Write to client..."
    class="chat-input"
  ></textarea>
  <button id="adminSendBtn" type="button" class="btn">Send</button>
</form>

<% if (order.status !== 'accepted' && order.status !== 'completed') { %>
<form
  method="post"
  action="/admin/orders/<%= order.id %>/accept"
  style="margin-top: 12px"
>
  <button type="submit" class="btn">Accept Order (Assign to me)</button>
</form>
<% } else if (order.status === 'accepted') { %>
<form
  method="post"
  action="/admin/orders/<%= order.id %>/done"
  style="margin-top: 12px"
>
  <button type="submit" class="btn">Mark as done (Delivered & Paid)</button>
</form>
<% } else { %>
<div style="margin-top: 8px; color: #666">This order is completed.</div>
<% } %>

<script>
  document
    .getElementById('adminSendBtn')
    .addEventListener('click', async () => {
      const text = document.getElementById('adminMessage').value.trim();
      if (!text) return;
      await fetch('/chat/message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderId: '<%= order.id %>', message: text }),
      });
      location.reload();
    });
</script>
