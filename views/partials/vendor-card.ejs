<!--views/partials/vendor-card.ejs-->
<% /* Partial: vendor-card.ejs
     Expects local `v` (vendor object). Optionally `currentUser` in parent scope.
     Provides vendorImageFor logic and outputs a vendor-card with data-vendor-id. */ %>
<%
  function normalizeKey(s) {
    if (!s) return '';
    return String(s).toLowerCase()
      .replace(/&/g, 'and')
      .replace(/\s+/g, '_')
      .replace(/[^\w_]/g, '');
  }

  const FOOD_IMAGES = {
    jollof: '/images/food/jollof.jpg',
    white_rice_stew: '/images/food/white_rice_stew.jpg',
    fried_rice: '/images/food/fried_rice.jpg',
    eba_egusi: '/images/food/eba_egusi.jpg',
    amala_ewedu: '/images/food/amala_ewedu.jpg',
    beans_ewa_riro: '/images/food/beans_ewa_riro.jpg',
    akara: '/images/food/akara.jpg',
    moi_moi: '/images/food/moi_moi.jpg',
    pounded_yam_egusi: '/images/food/pounded_yam_egusi.jpg',
    ofada_ayamase: '/images/food/ofada_ayamase.jpg',
    suya: '/images/food/suya.jpg',
    fish_pepper_soup: '/images/food/fish_pepper_soup.jpg',
    plantain_stew: '/images/food/plantain_stew.jpg',
    spaghetti_meat: '/images/food/spaghetti_meat.jpg',
    okro_fufu: '/images/food/okro_fufu.jpg',
    salad: '/images/food/salad.jpg',
    grilled_chicken: '/images/food/grilled_chicken.jpg',
    placeholder: '/images/food/placeholder.jpg'
  };

  function vendorImageFor(vendor) {
    if (!vendor) return FOOD_IMAGES.placeholder;
    const p = vendor.photo_url ? String(vendor.photo_url).trim() : '';
    if (p && (/^https?:\/\//i.test(p) || p.startsWith('/'))) return p;
    const key = normalizeKey(vendor.food_item || vendor.food || vendor.name || '');
    if (key && FOOD_IMAGES[key]) return FOOD_IMAGES[key];
    return FOOD_IMAGES.placeholder;
  }

  const vImg = vendorImageFor(v);
%>

<article class="vendor-card" data-vendor-id="<%= v.id %>">
  <div class="vendor-media">
    <a
      class="vendor-thumb-link"
      href="/vendor/<%= v.id %>"
      aria-label="Open vendor <%= v.name %>"
      title="View <%= v.name %>"
    >
      <img
        class="vendor-photo <%= (vImg === FOOD_IMAGES.placeholder) ? 'placeholder-rotating' : '' %>"
        alt="Photo of <%= v.food_item %> by <%= v.name %>"
        src="<%= vImg %>"
        onerror="this.onerror=null;this.src='<%= FOOD_IMAGES.placeholder %>'"
        loading="lazy"
      />
    </a>
  </div>

  <div class="vendor-body">
    <h4><a href="/vendor/<%= v.id %>"><%= v.name %></a></h4>
    <p><strong>Food:</strong> <%= v.food_item %></p>
    <p><strong>Price (per plate):</strong> â‚¦<%= v.base_price %></p>
    <p><strong>Address:</strong> <%= v.address %> (<%= v.lga %>, <%= v.state %>)</p>

    <form method="post" action="/client/book">
      <input type="hidden" name="vendorId" value="<%= v.id %>" />
      <input type="text" name="item" placeholder="Special request (optional)" />
      <select name="payment_method">
        <option value="cod">Pay on delivery</option>
        <option value="wallet">Pay from wallet</option>
        <option value="paystack">Pay online (Paystack)</option>
        <option value="flutterwave">Pay online (Flutterwave)</option>
      </select>

      <div style="margin-top:10px">
        <button type="submit" class="btn">Book / Order</button>

        <button
          type="button"
          class="btn btn-sm btn-leave-review"
          data-vendor-id="<%= v.id %>"
          data-vendor-name="<%= v.name %>"
          style="margin-left: 8px"
        >
          Leave a Review
        </button>
      </div>
    </form>
  </div>
</article>
