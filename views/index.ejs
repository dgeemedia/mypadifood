<!--views/index.ejs-->
<%
  // defensive locals + helpers
  const f = (typeof filters !== 'undefined' && filters) ? filters : {};
  const initialVisible = 9;
  const vendorsList = (typeof vendors !== 'undefined' && vendors) ? vendors : [];
  const partnersList = (typeof partners !== 'undefined' && partners) ? partners : [];
  const testimonialsList = (typeof testimonials !== 'undefined' && testimonials) ? testimonials : [];
  const statsSafe = (typeof stats !== 'undefined' && stats) ? stats : {};
  const currentUserSafe = (typeof currentUser !== 'undefined' && currentUser) ? currentUser : null;

  // small SVG fallback encoded
  const fallbackSvg = encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400">
       <rect width="100%" height="100%" fill="#f6f7fb"/>
       <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="18" fill="#888">Image unavailable</text>
     </svg>`
  );

  // FOOD images map (place files under /public/images/food/)
  const FOOD_IMAGES = {
    jollof: '/images/food/jollof.jpg',
    white_rice_stew: '/images/food/white_rice_stew.jpg',
    fried_rice: '/images/food/fried_rice.jpg',
    eba_egusi: '/images/food/eba_egusi.jpg',
    amala_ewedu: '/images/food/amala_ewedu.jpg',
    beans_ewa_riro: '/images/food/beans_ewa_riro.jpg',
    akara: '/images/food/akara.jpg',
    moi_moi: '/images/food/moi_moi.jpg',
    pounded_yam_egusi: '/images/food/pounded_yam_egusi.jpg',
    ofada_ayamase: '/images/food/ofada_ayamase.jpg',
    suya: '/images/food/suya.jpg',
    fish_pepper_soup: '/images/food/fish_pepper_soup.jpg',
    plantain_stew: '/images/food/plantain_stew.jpg',
    spaghetti_meat: '/images/food/spaghetti_meat.jpg',
    okro_fufu: '/images/food/okro_fufu.jpg',
    salad: '/images/food/salad.jpg',
    grilled_chicken: '/images/food/grilled_chicken.jpg',
    placeholder: '/images/food/placeholder.jpg'
  };

  function normalizeKey(s) {
    if (!s) return '';
    return String(s).toLowerCase()
      .replace(/&/g, 'and')
      .replace(/\s+/g, '_')
      .replace(/[^\w_]/g, '');
  }

  function vendorImageFor(v) {
    if (!v) return FOOD_IMAGES.placeholder;
    const p = v.photo_url ? String(v.photo_url).trim() : '';
    if (p && (/^https?:\/\//i.test(p) || p.startsWith('/'))) return p;
    const key = normalizeKey(v.food_item || v.food || v.name || '');
    if (key && FOOD_IMAGES[key]) return FOOD_IMAGES[key];
    return FOOD_IMAGES.placeholder;
  }

  const heroImage = '/images/hero-food.jpg';
%>

<!-- Full-bleed hero (replace previous hero section with this) -->
<section class="hero homepage" aria-label="Hero">
  <div class="hero-inner">
    <!-- left column: heading, search, CTAs, metrics -->
    <div class="hero-left">
      <h1>Local Food Vendors in Your Area</h1>
      <p class="lead">
        Discover delicious, home-cooked meals from trusted local vendors. Fast
        delivery or pickup ‚Äî order in seconds.
      </p>

      <form class="hero-search" method="get" action="/">
        <input
          type="text"
          name="q"
          placeholder="Search vendor or food item"
          value="<%= f.q ? f.q : '' %>"
        />
        <input
          type="text"
          name="state"
          placeholder="State"
          value="<%= f.state ? f.state : '' %>"
        />
        <input
          type="text"
          name="lga"
          placeholder="LGA"
          value="<%= f.lga ? f.lga : '' %>"
        />
        <button class="btn btn-primary" type="submit">Search</button>
      </form>

      <div class="hero-ctas">
        <a class="btn btn-secondary" href="/signup">Join as Customer</a>
        <a class="btn" href="/vendor/register">Register Your Food Stall</a>
        <a class="btn btn-gold" href="/invest">Invest / Partner</a>
      </div>

      <div class="platform-metrics cards" aria-hidden="true">
        <div class="metric-card">
          <div class="metric-icon">üë©‚Äçüç≥</div>
          <div>
            <strong><%= statsSafe.vendors || 0 %></strong>
            <small>Vendors enrolled</small>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-icon">üßæ</div>
          <div>
            <strong><%= statsSafe.orders || 0 %></strong>
            <small>Orders made</small>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-icon">üë•</div>
          <div>
            <strong><%= statsSafe.customers || 0 %></strong>
            <small>Customers onboarded</small>
          </div>
        </div>
      </div>
    </div>

    <!-- right column: hero media (aspect box) -->
    <div class="hero-right">
      <div class="hero-media" role="img" aria-label="Delicious local food">
        <img
          src="<%= heroImage %>"
          alt="Delicious local food"
          onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<%= fallbackSvg %>'"
        />
      </div>
    </div>
  </div>
</section>

<!-- Featured vendors (horizontal scroll) -->
<section class="featured container homepage" aria-label="Featured vendors">
  <h2>Featured vendors</h2>

  <div class="featured-scroller" tabindex="0" role="list">
    <% (vendorsList || []).slice(0,6).forEach(function(v) { %>
      <% const imgSrc = vendorImageFor(v); %>

      <!-- entire card is clickable; include aria-label for screen readers -->
      <a class="featured-item" href="/vendor/<%= v.id %>" role="listitem" aria-label="<%= v.name %> ‚Äî <%= v.food_item %>">
        <div class="featured-thumb" aria-hidden="true">
          <img
            alt="<%= v.food_item || 'meal' %>"
            src="<%= imgSrc %>"
            onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<%= fallbackSvg %>'"
            loading="lazy"
          />
          <!-- price badge -->
          <div class="featured-price">‚Ç¶<%= v.base_price %></div>
        </div>

        <div class="featured-meta">
          <div class="featured-title"><%= v.name %></div>
          <div class="featured-sub"><%= v.food_item %></div>
        </div>
      </a>
    <% }) %>

    <% if (!(vendorsList && vendorsList.length)) { %>
      <div class="featured-empty muted">No featured vendors yet.</div>
    <% } %>
  </div>
</section>


<!-- Vendors grid -->
<section class="vendors container homepage">
  <h2>Nearby Vendors</h2>

  <% if (!vendorsList.length) { %>
    <p>No vendors found. Try another location.</p>
  <% } else { %>

    <div id="vendors-grid" class="vendors-grid" data-initial="<%= initialVisible %>">
      <% vendorsList.forEach(function(v, index) { %>
        <% const avg = (v.reviewsSummary && v.reviewsSummary.avg_rating) || 0; %>
        <% const rounded = Math.round(Number(avg || 0)); %>
        <% const vImg = vendorImageFor(v); %>

        <% const classes = ['vendor-card']; if (index >= initialVisible) classes.push('vendor-hidden'); %>
<article class="<%= classes.join(' ') %>" data-vendor-id="<%= v.id %>" data-index="<%= index %>">

          <div class="vendor-media">
            <img
              class="vendor-photo"
              alt="Photo of <%= v.food_item %> by <%= v.name %>"
              src="<%= vImg %>"
              onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<%= fallbackSvg %>'"
              loading="lazy"
            />
            <button class="fav-btn" title="Save vendor" aria-pressed="false" data-vendor-id="<%= v.id %>">‚ô°</button>
          </div>

          <div class="vendor-body">
            <h3 class="vendor-title">
              <a href="/vendor/<%= v.id %>"><%= v.name %></a>
            </h3>
            <p class="vendor-food"><strong>Food:</strong> <%= v.food_item %></p>
            <p class="vendor-price"><strong>Price:</strong> ‚Ç¶<%= v.base_price %></p>
            <p class="vendor-address"><%= v.lga %>, <%= v.state %></p>

            <div class="rating-inline" aria-hidden="true">
              <span class="stars" title="<%= typeof avg.toFixed === 'function' ? avg.toFixed(2) : avg %>">
                <% for (let i = 1; i <= 5; i++) { %><%= i <= rounded ? '‚òÖ' : '‚òÜ' %><% } %>
              </span>
              <small class="muted"><%= (v.reviewsSummary && v.reviewsSummary.review_count) || 0 %> reviews</small>
            </div>

            <div class="card-actions">
              <button
                class="btn btn-gold quick-order"
                data-vendor-id="<%= v.id %>"
                data-vendor-name="<%= v.name %>"
                data-logged-in="<%= currentUserSafe ? '1' : '' %>"
              >
                Quick order
              </button>

              <a class="btn btn-muted" href="/vendor/<%= v.id %>">View vendor</a>
            </div>
          </div>
        </article>

      <% }) /* end vendors foreach */ %>
    </div>

    <div class="vendors-actions container">
      <button id="show-more" class="btn">Show more vendors</button>
      <small class="muted" id="infinite-hint">Scroll to load more (auto enabled)</small>
    </div>

  <% } %>
</section>

<!-- Partners -->
<section class="partners container homepage" aria-label="Partners & supporters">
  <h2>Our Partners</h2>
  <div class="partners-row" role="list">
    <% if (partnersList && partnersList.length) { %>
      <% partnersList.forEach(function(p) { %>
        <div class="partner" role="listitem">
          <img
            src="<%= p.logo_url || '/images/partner-placeholder.png' %>"
            alt="<%= p.name %>"
            onerror="this.onerror=null;this.src='/images/partner-placeholder.png'"
          />
        </div>
      <% }) %>
    <% } else { %>
      <div class="partner">
        <img src="/images/partner-placeholder.png" alt="No partners yet" />
      </div>
    <% } %>
  </div>

  <p class="partners-note">
    Want your brand here?
    <a href="mailto:support@mypadifood.com?subject=Partner%20with%20MyPadiFood">Partner with us</a>.
  </p>
</section>

<!-- Testimonials -->
<section class="testimonials container homepage" aria-label="Customer testimonials">
  <h2>What our customers say</h2>

  <div class="testi-grid">
    <% if (Array.isArray(testimonialsList) && testimonialsList.length) { %>
      <% testimonialsList.forEach(function(t) { %>
        <% const avatarSrc = (t && t.avatar) || (t && t.photo_url) || (t && t.gender === 'female' ? '/images/avatars/human-female.jpg' : t && t.gender === 'male' ? '/images/avatars/human-male.jpg' : '/images/avatars/human-generic.jpg'); %>
        <blockquote class="testi-card" tabindex="0" aria-label="Customer testimonial">
          <div class="testi-photo" aria-hidden="false">
            <img
              src="<%= avatarSrc %>"
              alt="<%= (t && (t.name || 'Customer')) %>'s avatar"
              width="64" height="64"
              onerror="this.onerror=null;this.src='/images/avatars/human-generic.jpg';"
              class="testimonial-avatar"
            />
          </div>

          <div class="testi-body">
            <p class="quote">‚Äú<%= (t && t.quote) ? t.quote : '' %>‚Äù</p>
            <footer class="testi-meta">
              <strong><%= (t && t.name) ? t.name : 'Anonymous' %></strong>
              <% if (t && t.city) { %><small><%= t.city %></small><% } %>
            </footer>
          </div>
        </blockquote>
      <% }) %>
    <% } else { %>
      <p class="muted">No testimonials yet ‚Äî ask customers to leave feedback after ordering.</p>
    <% } %>
  </div>
</section>

<!-- Investor / Footer CTA -->
<section class="investor-cta container homepage">
  <div class="investor-inner">
    <div>
      <h3>Invest in local food entrepreneurship</h3>
      <p>
        We connect trusted vendors to thousands of customers. Join us to scale
        healthy income for local cooks and capture a high-growth market in
        quick-service food.
      </p>
    </div>
    <div class="investor-actions">
      <a href="/invest" class="btn btn-gold">See pitch deck</a>
      <a href="/contact" class="btn btn-gold">Contact sales</a>
    </div>
  </div>
</section>

<!-- Quick Order modal -->
<div id="quick-order-modal" class="modal" aria-hidden="true">
  <div class="modal-dialog" role="dialog" aria-modal="true">
    <button class="modal-close" aria-label="Close">√ó</button>
    <h3 id="qo-title">Quick order</h3>

    <form id="quick-order-form" method="post" action="/client/book">
      <input type="hidden" name="vendorId" id="qo-vendorId" value="" />
      <label>
        Item (optional)
        <input type="text" name="item" id="qo-item" placeholder="E.g. 2 plates, extra pepper" />
      </label>
      <label>
        Payment method
        <select name="payment_method" id="qo-payment">
          <option value="cod">Pay on delivery</option>
          <option value="paystack">Paystack</option>
          <option value="flutterwave">Flutterwave</option>
        </select>
      </label>

      <div class="modal-actions">
        <button type="submit" class="btn btn-gold">Place order</button>
        <button type="button" class="btn btn-muted modal-cancel">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script src="/js/index.js" defer></script>
